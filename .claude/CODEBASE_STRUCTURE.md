# Codebase Structure

**Version**: 1.0.0
**Last Updated**: December 22, 2025
**Generated By**: /bootstrap
**Status**: Active

---

## Technology Stack

| Category | Technology | Version |
|----------|------------|---------|
| Runtime | Node.js | Latest LTS |
| Framework | Express.js | 4.18.2 |
| Database | MongoDB | 7.x |
| ODM | Mongoose | 7.5.0 |
| Frontend | Vanilla HTML/CSS/JS | - |
| CSS | Tailwind CSS | - |
| AI/LLM | OpenAI GPT / Ollama | 4.x |
| Auth | JWT (jsonwebtoken) | 9.0.0 |
| Testing | Jest | 30.0.0 |
| Validation | Joi, express-validator | 17.9.2 |
| Security | Helmet, express-rate-limit, hpp | 7.0.0 |

---

## Service Architecture

| Service | Port | Technology | Purpose |
|---------|------|------------|---------|
| KARVIA Server | 5001 | Express.js | Main API backend |
| Client | 5001 | Static HTML | Frontend UI (served by Express) |
| MongoDB | 27017 | MongoDB | Data persistence |
| Ollama | 11434 | Ollama | Local LLM (optional) |

---

## Directory Structure

```
KARVIA/
├── .claude/                    # Claude Code governance & commands
│   ├── commands/               # Slash command definitions
│   ├── templates/              # Document templates
│   ├── DOCUMENT_STANDARDS.md   # Governance standards
│   ├── BEST_PRACTICES.md       # Development practices
│   └── MASTER_GUIDE.md         # File placement rules
│
├── .github/                    # GitHub configuration
│   ├── ISSUE_TEMPLATE/         # Issue templates
│   └── workflows/              # CI/CD pipelines (12 workflows)
│
├── client/                     # Frontend UI
│   ├── index.html              # Login page
│   ├── home.html               # Dashboard
│   ├── goals.html              # Weekly goals
│   ├── tasks.html              # Task management
│   ├── journey.html            # Journey progress
│   ├── vision-questionnaire.html
│   ├── pm-assessment.html      # PM assessment
│   ├── pages/scripts/          # Frontend JavaScript (25 files)
│   └── js/                     # Additional scripts
│
├── server/                     # Backend API
│   ├── index.js                # Express entry point
│   ├── routes/                 # API route handlers (23 files)
│   ├── models/                 # Mongoose schemas (10 files)
│   ├── services/               # Business logic (33 files)
│   ├── middleware/             # Auth & permissions (2 files)
│   └── api/                    # Additional API routes & tests
│
├── config/                     # Configuration files
│   └── .env.example            # Environment template
│
├── scripts/                    # Utility scripts (10 files)
│   ├── ci/                     # CI helper scripts
│   └── *.sh                    # Misc automation
│
├── qa/                         # Quality assurance
│   ├── automation/             # Automated tests
│   │   ├── tests/              # Test files
│   │   └── node-tests/         # Node-based tests
│   ├── ci/                     # CI configuration
│   └── reports/                # Test reports
│
├── test/                       # Jest test setup
│   └── setup.js                # Test configuration
│
├── package.json                # Dependencies & scripts
├── render.yaml                 # Render deployment config
├── vercel.json                 # Vercel deployment config
└── README.md                   # Project documentation
```

---

## API Endpoints

### Authentication (`/api/auth`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| POST | `/register` | auth.js | Create account |
| POST | `/login` | auth.js | User login |
| GET | `/user` | auth.js | Get current user |

### Weekly Goals (`/api/weeklyGoals`, `/api/goals`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| GET | `/?weekOf=<date>` | goals.js | Get weekly goals |
| POST | `/` | goals.js | Create goal |
| PUT | `/:id` | goals.js | Update goal |
| DELETE | `/:id` | goals.js | Delete goal |

### Tasks (`/api/tasks`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| GET | `/` | tasks.js | Get all tasks |
| POST | `/` | tasks.js | Create task |
| PUT | `/:id` | tasks.js | Update task |
| DELETE | `/:id` | tasks.js | Delete task |

### Journey (`/api/journey`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| GET | `/` | journeyCore.js | Get user journey |
| POST | `/` | journeyCore.js | Update journey |
| GET | `/progress` | journeyCore.js | Get progress |

### Vision & Assessment (`/api/vision`, `/api/pm-assessment`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| POST | `/submit` | vision.js | Submit vision assessment |
| GET | `/profile` | vision.js | Get vision profile |
| POST | `/pm-assessment` | pmAssessment.js | Submit PM assessment |

### AI/LLM (`/api/llm`, `/api/ollama`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| POST | `/generate` | llm.js | Generate content |
| POST | `/plan-week` | llm.js | Generate weekly plan |
| GET | `/status` | llm.js | Check LLM status |
| POST | `/ollama/generate` | ollama.js | Ollama generation |

### Dreams (`/api/dreams`, `/api/dream-parser`)
| Method | Path | Handler | Purpose |
|--------|------|---------|---------|
| GET | `/` | dreams.js | Get parsed dreams |
| POST | `/parse` | dreamParserSimple.js | Parse dream input |

### Additional Routes
| Route | Handler | Purpose |
|-------|---------|---------|
| `/api/home` | home.js | Dashboard data |
| `/api/analytics` | analytics.js | Usage analytics |
| `/api/manifest` | manifest.js | App manifest |
| `/api/config` | config.js | App configuration |
| `/api/task-chat` | taskChat.js | Task chat interactions |
| `/api/users` | users.js | User management |
| `/api/consumer/journey` | consumer-journey.js | Consumer journey |
| `/api/reflections` | reflections.js | User reflections |
| `/health` | index.js | Health check |

---

## Data Models

| Model | Location | Key Fields | Relations |
|-------|----------|-----------|-----------|
| User | models/User.js | email, password, name | Has many: Tasks, Goals, Journey |
| WeeklyGoal | models/WeeklyGoal.js | title, weekOf, userId | Belongs to: User |
| Task | models/Task.js | title, day, completed, userId | Belongs to: User, WeeklyGoal |
| Journey | models/Journey.js | stage, currentDay, userId | Belongs to: User |
| VisionProfile | models/VisionProfile.js | learningStyle, timeline, userId | Belongs to: User |
| UserDream | models/UserDream.js | dreamText, parsedGoals | Belongs to: User |
| DreamDiscovery | models/DreamDiscovery.js | keywords, analysis | Belongs to: User |
| TaskChatLog | models/TaskChatLog.js | messages, taskId | Belongs to: Task |
| pmAssessment | models/pmAssessment.js | responses, scores | Belongs to: User |
| visionData | models/visionData.js | preferences, analysis | Belongs to: User |

---

## Services Layer

### Core Services
| Service | File | Purpose |
|---------|------|---------|
| LLM Service | llmService.js | OpenAI/Ollama integration |
| Ollama Service | ollama.js | Local LLM provider |
| Llama Service | llamaService.js | Llama model integration |
| Email Service | emailService.js | Email notifications |
| Permission Service | permissionService.js | Access control |

### Journey & Stage Services
| Service | File | Purpose |
|---------|------|---------|
| Journey Service | journeyService.js | Journey progression |
| Journey Manager | journeyManager.js | Journey state management |
| Stage Manager | stageManager.js | Stage transitions |
| Onboarding Scorer | OnboardingStageScorer.js | Onboarding scoring |
| Discovery Scorer | DiscoveryStageScorer.js | Discovery scoring |
| Discovery Task Gen | DiscoveryTaskGenerator.js | Generate discovery tasks |

### Scoring & Analysis Services
| Service | File | Purpose |
|---------|------|---------|
| Comprehensive Scoring | comprehensiveScoringEngine.js | Full scoring logic |
| PM Scoring | pmScoringEngine.js | PM assessment scoring |
| Vision Scoring | visionScoringService.js | Vision profile scoring |
| Score Calculator | scoreCalculator.js | Score computations |
| Score Mapper | scoreMapper.js | Score transformations |
| Scoring Consent | ScoringConsentService.js | Consent management |

### Vision & Analysis Services
| Service | File | Purpose |
|---------|------|---------|
| Vision Analysis | visionAnalysisService.js | Vision profiling |
| Vision Data | visionDataService.js | Vision data storage |
| Vision Response | visionResponseAnalyzer.js | Response analysis |
| Vision to Preferences | visionToPreferencesService.js | Preference mapping |
| Enhanced Vision | enhancedVisionScoring.js | Advanced scoring |

### Utility Services
| Service | File | Purpose |
|---------|------|---------|
| Dream Parser | dreamParser.js | Parse dream input |
| Adaptation Engine | adaptationEngine.js | Adaptive recommendations |
| Habit Loop Engine | habitLoopEngine.js | Habit tracking |
| Data Flow Optimizer | DataFlowOptimizer.js | Data optimization |
| Reminder Scheduler | reminderScheduler.js | Scheduled reminders |
| Sprint AI Service | sprintAIService.js | Sprint planning AI |
| LLM Insights | llmInsights.js | AI-generated insights |
| Text Analyzer | utils/textAnalyzer.js | Text processing |

---

## Test Coverage

| Category | Location | Framework | Count |
|----------|----------|-----------|-------|
| Unit Tests | server/api/*.test.js | Jest | 3 |
| Integration | qa/automation/ | Custom | 1 |
| Debug Tests | qa/automation/tests/debug/ | Node | 15+ |
| Manual Tests | qa/automation/tests/manual/ | HTML | 1 |

---

## CI/CD Pipelines

| Workflow | File | Purpose |
|----------|------|---------|
| Deploy | deploy.yml | Production deployment |
| E2E Tests | agents-e2e.yml | Agent E2E tests |
| Contracts | contracts.yml | API contract testing |
| QA Gates | qa-gates.yml | Quality gates |
| Health Check | health-check.yml | Health monitoring |
| Docs Validate | docs-validate.yml | Documentation validation |
| Pipeline Validation | pipeline-validation.yml | Pipeline checks |
| Daily Status | daily-status.yml | Daily reports |
| Flaky Nightly | flaky-nightly.yml | Flaky test detection |
| Sitemap Check | sitemap-check.yml | Sitemap validation |

---

## Quick Reference

| Task | Command | Location |
|------|---------|----------|
| Install dependencies | `npm install` | package.json |
| Start server | `npm start` | server/index.js |
| Start dev (auto-reload) | `npm run server` | server/index.js |
| Run tests | `npm test` | Jest config |
| Build | `npm run build` | package.json |
| Health check | `curl localhost:5001/health` | /health endpoint |

---

## Environment Configuration

| Variable | Required | Default | Purpose |
|----------|----------|---------|---------|
| MONGO_URI | Yes | - | MongoDB connection string |
| JWT_SECRET | Yes | - | JWT signing secret |
| JWT_EXPIRATION | No | 24h | Token expiration |
| PORT | No | 5001 | Server port |
| NODE_ENV | No | development | Environment |
| LLM_PROVIDER | No | openai | LLM provider (openai/ollama) |
| OPENAI_API_KEY | Conditional | - | Required if LLM_PROVIDER=openai |
| OLLAMA_BASE_URL | No | localhost:11434 | Ollama server URL |
| OLLAMA_MODEL | No | llama3.2:latest | Ollama model name |

---

## Deployment Targets

| Platform | Config File | Notes |
|----------|-------------|-------|
| Render | render.yaml | Production deployment |
| Vercel | vercel.json | Alternative deployment |

---

**Session Seal**
- **Generated**: December 22, 2025
- **Command**: /bootstrap
- **Purpose**: Codebase structure documentation
