name: ğŸ¤– Agents E2E Smoke Test

on:
  push:
    paths:
      - 'agents/**'
      - '.github/workflows/agents-e2e.yml'
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install ajv@latest ajv-formats@latest

      - name: ğŸš€ Initialize message bus
        run: |
          echo "ğŸ”§ Initializing agent directories and message bus..."
          node agents/shared/protocols/bus.js init
          echo "âœ… Message bus initialized"

      - name: ğŸŒ± Seed test feature
        run: |
          echo "ğŸŒ± Seeding test feature FT-999..."
          node agents/shared/protocols/bus.js send ORCHESTRATOR ARIA HANDOFF FT-999 \
            '{"status":"STARTED","artifacts":[],"metadata":{"note":"seeded for e2e test","testRun":true}}'
          echo "âœ… Test feature seeded"

      - name: ğŸ¯ Run ARIA + SYNTH agents
        run: |
          echo "ğŸ¯ Starting ARIA and SYNTH agents..."
          
          # Start ARIA in background with timeout
          timeout 20s node agents/aria/index.js &
          ARIA_PID=$!
          
          # Start SYNTH in background with timeout  
          timeout 20s node agents/synth/index.js &
          SYNTH_PID=$!
          
          # Wait for processing to complete
          echo "â³ Waiting for agents to process messages..."
          sleep 12
          
          # Kill background processes if still running
          kill $ARIA_PID $SYNTH_PID 2>/dev/null || true
          wait 2>/dev/null || true
          
          echo "âœ… Agent processing completed"

      - name: âœ… Verify artifacts created
        run: |
          echo "ğŸ” Verifying artifacts were created..."
          
          # Check ARIA artifacts
          if [[ ! -f "projects/FT-999/requirements.json" ]]; then
            echo "âŒ ARIA requirements.json not found"
            exit 1
          fi
          echo "âœ… ARIA requirements.json exists"
          
          if [[ ! -f "projects/FT-999/acceptance-criteria.json" ]]; then
            echo "âŒ ARIA acceptance-criteria.json not found"
            exit 1
          fi
          echo "âœ… ARIA acceptance-criteria.json exists"
          
          # Check SYNTH artifacts
          if [[ ! -f "projects/FT-999/design-spec.json" ]]; then
            echo "âŒ SYNTH design-spec.json not found"
            exit 1
          fi
          echo "âœ… SYNTH design-spec.json exists"
          
          echo "ğŸ‰ All expected artifacts found"

      - name: ğŸ” Verify pipeline state
        run: |
          echo "ğŸ” Verifying pipeline state progression..."
          
          # Check pipeline state file exists
          if [[ ! -f "agents/logs/pipeline/FT-999.json" ]]; then
            echo "âŒ Pipeline state file not found"
            exit 1
          fi
          
          # Verify final state using Node.js
          node -e "
            const fs = require('fs');
            try {
              const state = JSON.parse(fs.readFileSync('agents/logs/pipeline/FT-999.json', 'utf8'));
              console.log('ğŸ“Š Pipeline state:', state.state);
              console.log('ğŸ›ï¸ History entries:', state.history?.length || 0);
              console.log('ğŸ“„ ARIA artifacts:', state.artifacts?.ARIA?.length || 0);
              console.log('ğŸ“„ SYNTH artifacts:', state.artifacts?.SYNTH?.length || 0);
              
              // Verify final state
              if (!/SYNTH\.COMPLETED$/.test(state.state)) {
                console.error('âŒ Expected SYNTH.COMPLETED, got:', state.state);
                process.exit(1);
              }
              
              // Verify artifacts
              if (!state.artifacts?.ARIA?.length) {
                console.error('âŒ Missing ARIA artifacts in pipeline state');
                process.exit(1);
              }
              
              if (!state.artifacts?.SYNTH?.length) {
                console.error('âŒ Missing SYNTH artifacts in pipeline state');
                process.exit(1);
              }
              
              // Verify history progression
              const events = (state.history || []).map(h => \`\${h.agent}.\${h.event}\`);
              console.log('ğŸ“œ Pipeline events:', events.join(' â†’ '));
              
              console.log('âœ… Pipeline state validation passed');
            } catch (error) {
              console.error('âŒ Pipeline state validation failed:', error.message);
              process.exit(1);
            }
          "

      - name: ğŸ“Š Verify message logs
        run: |
          echo "ğŸ“Š Verifying message bus logs..."
          
          # Check if message logs exist
          LOG_FILE="agents/logs/messages/$(date +%Y-%m-%d).jsonl"
          
          if [[ ! -f "$LOG_FILE" ]]; then
            echo "âŒ Message log file not found: $LOG_FILE"
            ls -la agents/logs/messages/ || true
            exit 1
          fi
          
          # Count message events
          SENT_COUNT=$(grep -c '"event":"SENT"' "$LOG_FILE" || echo "0")
          RECEIVED_COUNT=$(grep -c '"event":"RECEIVED"' "$LOG_FILE" || echo "0")
          
          echo "ğŸ“¤ SENT messages: $SENT_COUNT"
          echo "ğŸ“¨ RECEIVED messages: $RECEIVED_COUNT"
          
          # Should have at least: ORCHESTRATORâ†’ARIA, ARIAâ†’SYNTH, SYNTHâ†’CODEX
          if [[ $SENT_COUNT -lt 3 ]]; then
            echo "âŒ Expected at least 3 SENT messages, got $SENT_COUNT"
            echo "ğŸ“‹ Log contents:"
            cat "$LOG_FILE"
            exit 1
          fi
          
          echo "âœ… Message flow validation passed"

      - name: ğŸ§¹ Check for orphaned processing files
        run: |
          echo "ğŸ§¹ Checking for orphaned processing files..."
          
          # Check for any files left in _processing directories
          ORPHANED=$(find agents/inbox/*//_processing -name "*.json" 2>/dev/null || true)
          
          if [[ -n "$ORPHANED" ]]; then
            echo "âŒ Found orphaned processing files:"
            echo "$ORPHANED"
            exit 1
          fi
          
          echo "âœ… No orphaned processing files found"

      - name: ğŸ” Check dead letter queue
        run: |
          echo "ğŸ” Checking dead letter queue..."
          
          # Check if any messages ended up in DLQ
          DLQ_COUNT=$(find agents/logs/dead-letter-queue -name "*.json" 2>/dev/null | wc -l || echo "0")
          
          echo "ğŸ’€ Dead letter messages: $DLQ_COUNT"
          
          if [[ $DLQ_COUNT -gt 0 ]]; then
            echo "âŒ Found messages in dead letter queue:"
            ls -la agents/logs/dead-letter-queue/ || true
            exit 1
          fi
          
          echo "âœ… No dead letter messages found"

      - name: ğŸ“‹ Test summary
        if: always()
        run: |
          echo "ğŸ“‹ E2E Smoke Test Summary"
          echo "========================="
          echo "âœ… Message bus initialized"
          echo "âœ… Test feature seeded"  
          echo "âœ… ARIA + SYNTH agents ran"
          echo "âœ… All artifacts created"
          echo "âœ… Pipeline state correct"
          echo "âœ… Message logs verified"
          echo "âœ… No orphaned files"
          echo "âœ… No dead letters"
          echo ""
          echo "ğŸ‰ E2E smoke test PASSED"

      - name: ğŸ› Debug on failure
        if: failure()
        run: |
          echo "ğŸ› DEBUG: Smoke test failed, gathering info..."
          echo ""
          echo "ğŸ“ Directory structure:"
          find agents/ projects/ -type f -name "*.json" | head -20
          echo ""
          echo "ğŸ“Š Pipeline states:"
          find agents/logs/pipeline -name "*.json" -exec echo "--- {} ---" \; -exec cat {} \; 2>/dev/null | head -50
          echo ""
          echo "ğŸ“œ Recent message logs:"
          find agents/logs/messages -name "*.jsonl" -exec tail -20 {} \; 2>/dev/null
          echo ""
          echo "ğŸ’€ Dead letters:"
          find agents/logs/dead-letter-queue -name "*.json" -exec cat {} \; 2>/dev/null | head -20
          echo ""
          echo "ğŸ§¹ Orphaned processing:"
          find agents/inbox/*//_processing -name "*.json" 2>/dev/null | head -10